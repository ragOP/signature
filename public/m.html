<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Checkout - Get your custom designer signature from Easy Soul Logo"
    />
    <title>Checkout - Easy Soul Logo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Great+Vibes&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --pink-light: #ff6b9d;
        --pink: #ec4899;
        --pink-dark: #be185d;
        --blue-light: #60a5fa;
        --blue: #3b82f6;
        --blue-dark: #1d4ed8;
        --purple: #a855f7;
        --bg-dark: #0f0a1a;
        --bg-card: rgba(255, 255, 255, 0.05);
        --text-primary: #ffffff;
        --text-secondary: rgba(255, 255, 255, 0.7);
        --text-muted: rgba(255, 255, 255, 0.5);
        --gradient-main: linear-gradient(
          135deg,
          var(--blue) 0%,
          var(--purple) 50%,
          var(--pink) 100%
        );
        --gradient-cta: linear-gradient(
          135deg,
          var(--pink) 0%,
          var(--purple) 50%,
          var(--blue) 100%
        );
        --gradient-bg: linear-gradient(
          180deg,
          #0f0a1a 0%,
          #1a0a2e 50%,
          #0a1628 100%
        );
        --shadow-glow: 0 0 40px rgba(168, 85, 247, 0.3);
        --radius: 16px;
        --green: #22c55e;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Poppins", sans-serif;
        background: var(--gradient-bg);
        color: var(--text-primary);
        line-height: 1.6;
        min-height: 100vh;
      }

      /* Header */
      .header {
        padding: 16px;
        background: rgba(15, 10, 26, 0.9);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .header-content {
        max-width: 600px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo {
        font-size: 1.4rem;
        font-weight: 700;
        background: var(--gradient-main);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-decoration: none;
      }

      .back-btn {
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: color 0.3s;
      }

      .back-btn:hover {
        color: var(--text-primary);
      }

      /* Main Content */
      .checkout-container {
        max-width: 500px;
        margin: 0 auto;
        padding: 30px 16px 50px;
      }

      .checkout-header {
        text-align: center;
        margin-bottom: 30px;
      }

      .checkout-title {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 8px;
        background: var(--gradient-main);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .checkout-subtitle {
        font-size: 0.95rem;
        color: var(--text-secondary);
      }

      /* Order Summary */
      .order-summary {
        background: var(--bg-card);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: var(--radius);
        padding: 20px;
        margin-bottom: 24px;
      }

      .summary-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .summary-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        font-size: 0.9rem;
        color: var(--text-secondary);
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }

      .summary-item:last-child {
        border-bottom: none;
      }

      .summary-total {
        display: flex;
        justify-content: space-between;
        padding: 16px 0 0;
        margin-top: 10px;
        border-top: 2px solid rgba(255, 255, 255, 0.1);
        font-size: 1.1rem;
        font-weight: 700;
      }

      .summary-total .amount {
        background: var(--gradient-main);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .price-badge {
        background: linear-gradient(135deg, var(--pink) 0%, var(--purple) 100%);
        padding: 2px 8px;
        border-radius: 20px;
        font-size: 0.65rem;
        font-weight: 700;
        margin-left: 8px;
      }

      /* Live Preview */
      .live-preview-box {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.1) 0%,
          rgba(236, 72, 153, 0.1) 100%
        );
        border: 1px solid rgba(168, 85, 247, 0.3);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        margin-bottom: 24px;
      }

      .live-preview-label {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-bottom: 8px;
      }

      .live-preview-signature {
        font-family: "Great Vibes", cursive;
        font-size: 2.5rem;
        background: var(--gradient-main);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        min-height: 60px;
      }

      /* Form */
      .checkout-form {
        background: var(--bg-card);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: var(--radius);
        padding: 24px;
      }

      .form-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 20px;
      }

      .form-group {
        margin-bottom: 18px;
      }

      .form-label {
        display: block;
        font-size: 0.85rem;
        font-weight: 500;
        margin-bottom: 8px;
        color: var(--text-secondary);
      }

      .form-input,
      .form-select,
      .form-textarea {
        width: 100%;
        padding: 14px 16px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        color: white;
        font-size: 1rem;
        font-family: inherit;
        transition: border-color 0.3s, box-shadow 0.3s;
      }

      .form-input:focus,
      .form-select:focus,
      .form-textarea:focus {
        outline: none;
        border-color: var(--purple);
        box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
      }

      .form-input::placeholder,
      .form-textarea::placeholder {
        color: var(--text-muted);
      }

      .form-select {
        appearance: none;
        cursor: pointer;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23ffffff' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 16px center;
      }

      .form-textarea {
        resize: vertical;
        min-height: 80px;
      }

      /* Submit Button */
      .submit-btn {
        width: 100%;
        padding: 18px;
        background: var(--gradient-cta);
        border: none;
        border-radius: 50px;
        color: white;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
        margin-top: 10px;
        position: relative;
        overflow: hidden;
      }

      .submit-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        animation: shimmer 2s infinite;
      }

      @keyframes shimmer {
        0% {
          left: -100%;
        }
        100% {
          left: 100%;
        }
      }

      .submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 40px rgba(168, 85, 247, 0.4);
      }

      .submit-btn:active {
        transform: scale(0.98);
      }

      .submit-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      /* Trust Badges */
      .trust-badges {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 24px;
        flex-wrap: wrap;
      }

      .trust-badge {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.8rem;
        color: var(--text-muted);
      }

      .trust-badge span:first-child {
        font-size: 1rem;
      }

      /* Features List */
      .features-list {
        margin-top: 24px;
        padding: 16px;
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.2);
        border-radius: 12px;
      }

      .features-list-item {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.85rem;
        color: var(--text-secondary);
        padding: 6px 0;
      }

      .features-list-item span:first-child {
        color: var(--green);
      }

      @media (min-width: 768px) {
        .checkout-container {
          padding: 50px 20px;
        }

        .checkout-title {
          font-size: 2.2rem;
        }
      }
    </style>
  </head>

  <body>
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <a href="index.html" class="logo">Easy Soul Logo</a>
        <a href="index.html" class="back-btn">‚Üê Back to Home</a>
      </div>
    </header>

    <!-- Checkout Content -->
    <div class="checkout-container">
      <div class="checkout-header">
        <h1 class="checkout-title">üé® Complete Your Order</h1>
        <p class="checkout-subtitle">
          You're one step away from your dream signature!
        </p>
      </div>

      <!-- Order Summary -->
      <div class="order-summary">
        <div class="summary-title">üì¶ Order Summary</div>
        <div class="summary-item">
          <span>Custom Designer Signature Package</span>
          <span>‚Çπ4,999</span>
        </div>
        <div class="summary-item">
          <span>Discount <span class="price-badge">90% OFF</span></span>
          <span style="color: var(--green)">-‚Çπ4,510</span>
        </div>
        <div class="summary-total">
          <span>Total</span>
          <span class="amount">‚Çπ489</span>
        </div>
      </div>

      <!-- Live Preview -->
      <div class="live-preview-box">
        <div class="live-preview-label">‚ú® Live Signature Preview</div>
        <div class="live-preview-signature" id="livePreview">Your Name</div>
      </div>

      <!-- Checkout Form -->
      <div class="checkout-form">
        <div class="form-title">üìù Your Details</div>

        <form id="checkoutForm" onsubmit="handleSubmit(event)">
          <div class="form-group">
            <label class="form-label" for="name">Your Full Name *</label>
            <input
              type="text"
              id="name"
              class="form-input"
              placeholder="Enter your full name"
              required
              oninput="updatePreview(this.value)"
            />
          </div>

          <div class="form-group">
            <label class="form-label" for="email">Email Address *</label>
            <input
              type="email"
              id="email"
              class="form-input"
              placeholder="your@email.com"
              required
            />
          </div>

          <div class="form-group">
            <label class="form-label" for="phone">WhatsApp / Phone *</label>
            <input
              type="tel"
              id="phone"
              class="form-input"
              placeholder="+91 98765 43210"
              required
            />
          </div>

          <div class="form-group">
            <label class="form-label" for="style">Preferred Style</label>
            <select id="style" class="form-select">
              <option value="professional">Professional Executive</option>
              <option value="elegant">Elegant Cursive</option>
              <option value="modern">Modern Minimal</option>
              <option value="creative">Creative Artistic</option>
              <option value="bold">Bold Statement</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label" for="notes"
              >Additional Notes (Optional)</label
            >
            <textarea
              id="notes"
              class="form-textarea"
              placeholder="Any special preferences or requirements..."
            ></textarea>
          </div>

          <button type="submit" class="submit-btn" id="submitBtn">
            üé® Submit Order - ‚Çπ489
          </button>
        </form>

        <!-- Features -->
        <div class="features-list">
          <div class="features-list-item">
            <span>‚úì</span>
            <span>3 unique signature designs</span>
          </div>
          <div class="features-list-item">
            <span>‚úì</span>
            <span>Step-by-step writing tutorial</span>
          </div>
          <div class="features-list-item">
            <span>‚úì</span>
            <span>Printable practice sheets</span>
          </div>
          <div class="features-list-item">
            <span>‚úì</span>
            <span>Delivery in 24-48 hours</span>
          </div>
        </div>
      </div>

      <!-- Trust Badges -->
      <div class="trust-badges">
        <div class="trust-badge">
          <span>üîí</span>
          <span>Secure Checkout</span>
        </div>
        <div class="trust-badge">
          <span>üíØ</span>
          <span>Satisfaction Guaranteed</span>
        </div>
        <div class="trust-badge">
          <span>‚ö°</span>
          <span>Fast Delivery</span>
        </div>
      </div>
    </div>

    <!-- Cashfree JS SDK -->
    <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>

  <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>

<script>
  // ===== Utils =====
  function updatePreview(value) {
    const preview = document.getElementById("livePreview");
    preview.textContent = value || "Your Name";
  }

  function setBtnLoading(isLoading, text) {
    const submitBtn = document.getElementById("submitBtn");
    if (!submitBtn) return;
    submitBtn.disabled = isLoading;
    submitBtn.innerHTML = isLoading ? (text || "‚è≥ Processing...") : "üé® Submit Order - ‚Çπ489";
  }

  function showError(msg) {
    alert(msg || "Something went wrong. Please try again.");
    setBtnLoading(false);
  }

  function safeJsonParse(text) {
    try { return JSON.parse(text); } catch { return null; }
  }

  // ===== Cashfree init (IMPORTANT) =====
  function getCashfreeInstance() {
    // If your backend creates sandbox sessions, change mode to "sandbox"
    if (typeof window.Cashfree !== "function") return null;
    return window.Cashfree({ mode: "production" });
  }

  // Extract payment_session_id from any common backend response shape
  function extractPaymentSessionId(payload) {
    if (!payload) return null;

    // Most common shapes:
    // 1) { payment_session_id: "..." }
    // 2) { data: { payment_session_id: "..." } }
    // 3) { data: { data: { payment_session_id: "..." } } }  (some wrappers)
    // 4) { paymentSessionId: "..." } (custom)
    return (
      payload.payment_session_id ||
      payload.paymentSessionId ||
      payload?.data?.payment_session_id ||
      payload?.data?.paymentSessionId ||
      payload?.data?.data?.payment_session_id ||
      payload?.data?.data?.paymentSessionId ||
      null
    );
  }

  // ===== Main submit =====
  async function handleSubmit(e) {
    e.preventDefault();
    setBtnLoading(true, "‚è≥ Processing...");

    const formData = {
      name: document.getElementById("name")?.value?.trim() || "",
      email: document.getElementById("email")?.value?.trim() || "",
      phone: document.getElementById("phone")?.value?.trim() || "",
      style: document.getElementById("style")?.value || "professional",
      notes: document.getElementById("notes")?.value?.trim() || "",
      amount: 489,
    };

    if (!formData.name || !formData.email || !formData.phone) {
      showError("Please fill Name, Email, and Phone.");
      return;
    }

    // 1) Create abandoned cart (non-blocking)
    try {
      const abdRes = await fetch(
        "https://signature-backend-x93b.onrender.com/api/lander30/create-order-abd",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            amount: formData.amount,
            fullName: formData.name,
            email: formData.email,
            phoneNumber: formData.phone,
            profession: formData.style,
            remarks: formData.notes,
            additionalProducts: [],
          }),
        }
      );
      const abdText = await abdRes.text();
      const abdData = safeJsonParse(abdText);
      const abdId = abdData?.data?._id;
      if (abdId) localStorage.setItem("abandonedCartID", abdId);
    } catch (err) {
      console.warn("Abandoned cart creation failed:", err);
    }

    // 2) Create payment session
    let paymentSessionId = null;
    let createSessionPayload = null;

    try {
      const res = await fetch(
        "https://signature-backend-x93b.onrender.com/api/payment/create-session",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            amount: formData.amount,
            fullName: formData.name,
            email: formData.email,
            phoneNumber: formData.phone,
            profession: formData.style,
            remarks: formData.notes,
            orderType: "normal",
            additionalProducts: [],
            quantity: 1,
            url: window.location.origin + "/cart.html",
          }),
        }
      );

      const raw = await res.text();
      createSessionPayload = safeJsonParse(raw);

      // üî• IMPORTANT: log exact backend response
      console.log("create-session status:", res.status);
      console.log("create-session payload:", createSessionPayload || raw);

      // If backend returned non-JSON
      if (!createSessionPayload) {
        throw new Error("Backend returned non-JSON: " + raw.slice(0, 200));
      }

      // If backend returned an error shape
      if (createSessionPayload.success === false) {
        throw new Error(createSessionPayload.message || createSessionPayload.error || "Session creation failed");
      }

      paymentSessionId = extractPaymentSessionId(createSessionPayload);

      if (!paymentSessionId) {
        // show top-level keys to debug quickly
        console.error("No payment_session_id found. Keys:", Object.keys(createSessionPayload || {}));
        throw new Error("No payment_session_id returned");
      }
    } catch (err) {
      console.error("Create session failed:", err);
      showError(
        "Failed to initiate payment. Backend did not return payment_session_id.\n\nCheck Console -> 'create-session payload'."
      );
      return;
    }

    // 3) Open Cashfree popup
    const cashfree = getCashfreeInstance();
    if (!cashfree) {
      showError("Cashfree SDK failed to load. Please refresh and try again.");
      return;
    }

    try {
      const result = await cashfree.checkout({
        paymentSessionId: paymentSessionId,
        redirectTarget: "_modal", // ‚úÖ popup/modal
      });

      if (result?.error) {
        console.error("Cashfree error:", result.error);
        showError("Payment failed or cancelled.");
        return;
      }

      if (!result?.paymentDetails) {
        showError("Payment not completed.");
        return;
      }

      // 4) Create order after payment
      setBtnLoading(true, "‚úÖ Payment received, saving order...");

      try {
        const orderRes = await fetch(
          "https://signature-backend-x93b.onrender.com/api/lander30/create-order",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              orderId: result.paymentDetails.order_id,
              amount: formData.amount,
              fullName: formData.name,
              email: formData.email,
              phoneNumber: formData.phone,
              style: formData.style,
              remarks: formData.notes,
              additionalProducts: [],
            }),
          }
        );

        const orderRaw = await orderRes.text();
        const orderData = safeJsonParse(orderRaw);

        console.log("create-order status:", orderRes.status);
        console.log("create-order payload:", orderData || orderRaw);

        if (!orderData?.success) {
          throw new Error(orderData?.message || "Order creation failed");
        }

        window.location.href = "thankyou.html";
      } catch (err) {
        console.error("Order creation failed:", err);
        showError("Payment success but order creation failed. Please contact support.");
      }
    } catch (err) {
      console.error("Checkout exception:", err);
      showError("Unable to open payment popup. Check domain whitelist + mode (sandbox/production).");
    }
  }
</script>

  </body>
</html>
