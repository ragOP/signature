<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Checkout - Get your custom designer signature from Easy Soul Logo"
    />
    <title>Checkout - Easy Soul Logo</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Great+Vibes&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        /* EXECUTIVE THEME */
        --bg-main: #0b0b0e;
        --bg-soft: #131318;
        --bg-card: rgba(255, 255, 255, 0.04);

        --gold: #c9a962;
        --gold-soft: rgba(201, 169, 98, 0.15);
        --gold-glow: 0 0 30px rgba(201, 169, 98, 0.35);

        --text-primary: #ffffff;
        --text-secondary: rgba(255, 255, 255, 0.72);
        --text-muted: rgba(255, 255, 255, 0.45);

        --border-soft: rgba(255, 255, 255, 0.08);
        --radius: 16px;
        --green: #22c55e;

        --gradient-gold: linear-gradient(
          135deg,
          #d4b670 0%,
          #c9a962 50%,
          #b89b55 100%
        );
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Poppins", sans-serif;
        background: radial-gradient(
            circle at top,
            rgba(201, 169, 98, 0.05),
            transparent 40%
          ),
          var(--bg-main);
        color: var(--text-primary);
        min-height: 100vh;
      }

      /* HEADER */
      .header {
        padding: 16px;
        background: rgba(11, 11, 14, 0.85);
        backdrop-filter: blur(18px);
        border-bottom: 1px solid var(--border-soft);
      }

      .header-content {
        max-width: 600px;
        margin: auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo {
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--gold);
        text-decoration: none;
        letter-spacing: 0.03em;
      }

      .back-btn {
        font-size: 0.85rem;
        color: var(--text-muted);
        text-decoration: none;
      }

      .back-btn:hover {
        color: var(--text-primary);
      }

      /* MAIN */
      .checkout-container {
        max-width: 500px;
        margin: auto;
        padding: 32px 16px 50px;
      }

      .checkout-header {
        text-align: center;
        margin-bottom: 32px;
      }

      .checkout-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--gold);
        margin-bottom: 8px;
      }

      .checkout-subtitle {
        font-size: 0.95rem;
        color: var(--text-secondary);
      }

      /* ORDER SUMMARY */
      .order-summary {
        background: var(--bg-card);
        border: 1px solid var(--border-soft);
        border-radius: var(--radius);
        padding: 20px;
        margin-bottom: 26px;
      }

      .summary-title {
        font-weight: 600;
        margin-bottom: 14px;
      }

      .summary-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        font-size: 0.9rem;
        color: var(--text-secondary);
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }

      .summary-total {
        display: flex;
        justify-content: space-between;
        margin-top: 14px;
        padding-top: 14px;
        border-top: 1px solid var(--border-soft);
        font-size: 1.1rem;
        font-weight: 700;
      }

      .summary-total .amount {
        color: var(--gold);
      }

      .price-badge {
        background: var(--gold-soft);
        color: var(--gold);
        padding: 2px 8px;
        border-radius: 20px;
        font-size: 0.65rem;
        font-weight: 700;
        margin-left: 6px;
      }

      /* LIVE PREVIEW */
      .live-preview-box {
        background: linear-gradient(
          180deg,
          rgba(201, 169, 98, 0.08),
          rgba(201, 169, 98, 0.02)
        );
        border: 1px solid var(--gold-soft);
        border-radius: 14px;
        padding: 20px;
        text-align: center;
        margin-bottom: 26px;
      }

      .live-preview-label {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-bottom: 8px;
      }

      .live-preview-signature {
        font-family: "Great Vibes", cursive;
        font-size: 2.6rem;
        color: var(--gold);
        text-shadow: var(--gold-glow);
        min-height: 60px;
      }

      /* FORM */
      .checkout-form {
        background: var(--bg-card);
        border: 1px solid var(--border-soft);
        border-radius: var(--radius);
        padding: 24px;
      }

      .form-title {
        font-weight: 600;
        margin-bottom: 20px;
      }

      .form-group {
        margin-bottom: 18px;
      }

      .form-label {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-bottom: 8px;
        display: block;
      }

      .form-input,
      .form-select,
      .form-textarea {
        width: 100%;
        padding: 14px 16px;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid var(--border-soft);
        border-radius: 12px;
        color: white;
        font-size: 0.95rem;
        transition: all 0.25s ease;
      }

      .form-input:focus,
      .form-select:focus,
      .form-textarea:focus {
        outline: none;
        border-color: var(--gold);
        box-shadow: 0 0 0 3px rgba(201, 169, 98, 0.15);
      }

      .form-textarea {
        resize: vertical;
        min-height: 90px;
      }

      /* SUBMIT */
      .submit-btn {
        width: 100%;
        padding: 18px;
        border-radius: 50px;
        border: none;
        background: var(--gradient-gold);
        color: #0b0b0e;
        font-weight: 800;
        font-size: 1.05rem;
        cursor: pointer;
        margin-top: 8px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--gold-glow);
      }

      .submit-btn:active {
        transform: scale(0.98);
      }

      /* FEATURES */
      .features-list {
        margin-top: 22px;
        padding: 16px;
        background: rgba(34, 197, 94, 0.08);
        border: 1px solid rgba(34, 197, 94, 0.2);
        border-radius: 12px;
      }

      .features-list-item {
        display: flex;
        gap: 10px;
        padding: 6px 0;
        font-size: 0.85rem;
        color: var(--text-secondary);
      }

      .features-list-item span:first-child {
        color: var(--green);
      }

      /* TRUST */
      .trust-badges {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 26px;
        flex-wrap: wrap;
      }

      .trust-badge {
        font-size: 0.8rem;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 6px;
      }
    </style>
  </head>

  <body>
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <a href="index.html" class="logo">Easy Soul Logo</a>
        <a href="index.html" class="back-btn">‚Üê Back to Home</a>
      </div>
    </header>

    <!-- Checkout Content -->
    <div class="checkout-container">
      <div class="checkout-header">
        <h1 class="checkout-title">üé® Complete Your Order</h1>
        <p class="checkout-subtitle">
          You're one step away from your dream signature!
        </p>
      </div>

      <!-- Order Summary -->
      <div class="order-summary">
        <div class="summary-title">üì¶ Order Summary</div>
        <div class="summary-item">
          <span>Custom Designer Signature Package</span>
          <span>‚Çπ4,999</span>
        </div>
        <div class="summary-item">
          <span>Discount <span class="price-badge">90% OFF</span></span>
          <span style="color: var(--green)">-‚Çπ4,510</span>
        </div>
        <div class="summary-total">
          <span>Total</span>
          <span class="amount">‚Çπ489</span>
        </div>
      </div>

  

      <!-- Checkout Form -->
      <div class="checkout-form">
        <div class="form-title">üìù Your Details</div>

        <form id="checkoutForm" onsubmit="handleSubmit(event)">
          <div class="form-group">
            <label class="form-label" for="name">Your Full Name *</label>
            <input
              type="text"
              id="name"
              class="form-input"
              placeholder="Enter your full name"
              required
              oninput="updatePreview(this.value)"
            />
          </div>

          <div class="form-group">
            <label class="form-label" for="email">Email Address *</label>
            <input
              type="email"
              id="email"
              class="form-input"
              placeholder="your@email.com"
              required
            />
          </div>

          <div class="form-group">
            <label class="form-label" for="phone">WhatsApp / Phone *</label>
            <input
              type="tel"
              id="phone"
              class="form-input"
              placeholder="+91 98765 43210"
              required
            />
          </div>

          <div class="form-group">
            <label class="form-label" for="style">Preferred Style</label>
            <select id="style" class="form-select">
              <option value="professional">Professional Executive</option>
              <option value="elegant">Elegant Cursive</option>
              <option value="modern">Modern Minimal</option>
              <option value="creative">Creative Artistic</option>
              <option value="bold">Bold Statement</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label" for="notes"
              >Additional Notes (Optional)</label
            >
            <textarea
              id="notes"
              class="form-textarea"
              placeholder="Any special preferences or requirements in your signtaure design "
            ></textarea>
          </div>

          <button type="submit" class="submit-btn" id="submitBtn">
            üé® Submit Order - ‚Çπ489
          </button>
        </form>

        <!-- Features -->
        <div class="features-list">
          <div class="features-list-item">
            <span>‚úì</span>
            <span>3 unique signature designs</span>
          </div>
          <div class="features-list-item">
            <span>‚úì</span>
            <span>Step-by-step writing tutorial</span>
          </div>
          <div class="features-list-item">
            <span>‚úì</span>
            <span>Printable practice sheets</span>
          </div>
          <div class="features-list-item">
            <span>‚úì</span>
            <span>Delivery in 24-48 hours</span>
          </div>
        </div>
      </div>

      <!-- Trust Badges -->
      <div class="trust-badges">
        <div class="trust-badge">
          <span>üîí</span>
          <span>Secure Checkout</span>
        </div>
        <div class="trust-badge">
          <span>üíØ</span>
          <span>Satisfaction Guaranteed</span>
        </div>
        <div class="trust-badge">
          <span>‚ö°</span>
          <span>Fast Delivery</span>
        </div>
      </div>
    </div>

    <!-- Cashfree JS SDK -->
    <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>

  <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>

<script>
  // ===== Utils =====
  function updatePreview(value) {
    const preview = document.getElementById("livePreview");
    preview.textContent = value || "Your Name";
  }

  function setBtnLoading(isLoading, text) {
    const submitBtn = document.getElementById("submitBtn");
    if (!submitBtn) return;
    submitBtn.disabled = isLoading;
    submitBtn.innerHTML = isLoading ? (text || "‚è≥ Processing...") : "üé® Submit Order - ‚Çπ489";
  }

  function showError(msg) {
    alert(msg || "Something went wrong. Please try again.");
    setBtnLoading(false);
  }

  function safeJsonParse(text) {
    try { return JSON.parse(text); } catch { return null; }
  }

  // ===== Cashfree init (IMPORTANT) =====
  function getCashfreeInstance() {
    // If your backend creates sandbox sessions, change mode to "sandbox"
    if (typeof window.Cashfree !== "function") return null;
    return window.Cashfree({ mode: "production" });
  }

  // Extract payment_session_id from any common backend response shape
  function extractPaymentSessionId(payload) {
    if (!payload) return null;

    // Most common shapes:
    // 1) { payment_session_id: "..." }
    // 2) { data: { payment_session_id: "..." } }
    // 3) { data: { data: { payment_session_id: "..." } } }  (some wrappers)
    // 4) { paymentSessionId: "..." } (custom)
    return (
      payload.payment_session_id ||
      payload.paymentSessionId ||
      payload?.data?.payment_session_id ||
      payload?.data?.paymentSessionId ||
      payload?.data?.data?.payment_session_id ||
      payload?.data?.data?.paymentSessionId ||
      null
    );
  }

  // ===== Main submit =====
  async function handleSubmit(e) {
    e.preventDefault();
    setBtnLoading(true, "‚è≥ Processing...");

    const formData = {
      name: document.getElementById("name")?.value?.trim() || "",
      email: document.getElementById("email")?.value?.trim() || "",
      phone: document.getElementById("phone")?.value?.trim() || "",
      style: document.getElementById("style")?.value || "professional",
      notes: document.getElementById("notes")?.value?.trim() || "",
      amount: 999,
    };

    if (!formData.name || !formData.email || !formData.phone) {
      showError("Please fill Name, Email, and Phone.");
      return;
    }

    // 1) Create abandoned cart (non-blocking)
    try {
      const abdRes = await fetch(
        "https://signature-backend-x93b.onrender.com/api/lander34/create-order-abd",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            amount: formData.amount,
            fullName: formData.name,
            email: formData.email,
            phoneNumber: formData.phone,
            profession: formData.style,
            remarks: formData.notes,
            additionalProducts: [],
          }),
        }
      );
      const abdText = await abdRes.text();
      const abdData = safeJsonParse(abdText);
      const abdId = abdData?.data?._id;
      if (abdId) localStorage.setItem("abandonedCartID", abdId);
    } catch (err) {
      console.warn("Abandoned cart creation failed:", err);
    }

    // 2) Create payment session
    let paymentSessionId = null;
    let createSessionPayload = null;

    try {
      const res = await fetch(
        "https://signature-backend-x93b.onrender.com/api/payment/create-session",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            amount: formData.amount,
            fullName: formData.name,
            email: formData.email,
            phoneNumber: formData.phone,
            profession: formData.style,
            remarks: formData.notes,
            orderType: "normal",
            additionalProducts: [],
            quantity: 1,
            url: window.location.origin + "/cartpro.html",
          }),
        }
      );

      const raw = await res.text();
      createSessionPayload = safeJsonParse(raw);

      // üî• IMPORTANT: log exact backend response
      console.log("create-session status:", res.status);
      console.log("create-session payload:", createSessionPayload || raw);

      // If backend returned non-JSON
      if (!createSessionPayload) {
        throw new Error("Backend returned non-JSON: " + raw.slice(0, 200));
      }

      // If backend returned an error shape
      if (createSessionPayload.success === false) {
        throw new Error(createSessionPayload.message || createSessionPayload.error || "Session creation failed");
      }

      paymentSessionId = extractPaymentSessionId(createSessionPayload);

      if (!paymentSessionId) {
        // show top-level keys to debug quickly
        console.error("No payment_session_id found. Keys:", Object.keys(createSessionPayload || {}));
        throw new Error("No payment_session_id returned");
      }
    } catch (err) {
      console.error("Create session failed:", err);
      showError(
        "Failed to initiate payment. Backend did not return payment_session_id.\n\nCheck Console -> 'create-session payload'."
      );
      return;
    }

    // 3) Open Cashfree popup
    const cashfree = getCashfreeInstance();
    if (!cashfree) {
      showError("Cashfree SDK failed to load. Please refresh and try again.");
      return;
    }

    try {
      const result = await cashfree.checkout({
        paymentSessionId: paymentSessionId,
        redirectTarget: "_modal", // ‚úÖ popup/modal
      });

      if (result?.error) {
        console.error("Cashfree error:", result.error);
        showError("Payment failed or cancelled.");
        return;
      }

      if (!result?.paymentDetails) {
        showError("Payment not completed.");
        return;
      }

      // 4) Create order after payment
      setBtnLoading(true, "‚úÖ Payment received, saving order...");

      try {
        const orderRes = await fetch(
          "https://signature-backend-x93b.onrender.com/api/lander34/create-order",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              orderId: `order - ${Date.now().toString(36)}`,
              amount: formData.amount,
              fullName: formData.name,
              email: formData.email,
              phoneNumber: formData.phone,
              style: formData.style,
              remarks: formData.notes,
              additionalProducts: [],
            }),
          }
        );

        const orderRaw = await orderRes.text();
        const orderData = safeJsonParse(orderRaw);

        console.log("create-order status:", orderRes.status);
        console.log("create-order payload:", orderData || orderRaw);

        if (!orderData?.success) {
          throw new Error(orderData?.message || "Order creation failed");
        }

         window.location.href = window.location.origin + "/thankyoupro.html?name=" + encodeURIComponent(formData.name) + "&email=" + encodeURIComponent(formData.email) + "&style=" + encodeURIComponent(formData.style);
      } catch (err) {
        console.error("Order creation failed:", err);
        showError("Payment success but order creation failed. Please contact support.");
      }
    } catch (err) {
      console.error("Checkout exception:", err);
      showError("Unable to open payment popup. Check domain whitelist + mode (sandbox/production).");
    }
  }
</script>

  </body>
</html>
