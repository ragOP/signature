<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Checkout - Get your custom designer signature from Easy Soul Logo"
    />
    <title>Checkout - Easy Soul Logo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Great+Vibes&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        /* ===== RoyalSign Theme (ONLY CSS change) ===== */
        --bg-brown: #5b3a37; /* outer brown */
        --paper: #ffffff; /* main white card */
        --ink: #111111; /* headings */
        --muted: #6b7280; /* helper text */
        --line: #e7e7e7; /* borders */
        --blackbar: #0c0c0c; /* top bar */
        --shadow: 0 18px 60px rgba(0, 0, 0, 0.35);
        --radius: 26px;
        --radius-sm: 18px;
        --green: #22c55e;
    
        /* keep your existing vars (no break) */
        --pink-light: #ff6b9d;
        --pink: #ec9999;
        --pink-dark: #be185d;
        --blue-light: #60a5fa;
        --blue: #3b82f6;
        --blue-dark: #1d4ed8;
        --purple: #a855f7;
        --bg-dark: #0f0a1a;
        --bg-card: rgba(255, 255, 255, 0.05);
        --text-primary: #ffffff;
        --text-secondary: rgba(255, 255, 255, 0.7);
        --text-muted: rgba(255, 255, 255, 0.5);
        --gradient-main: linear-gradient(135deg, #111 0%, #111 100%);
        --gradient-cta: linear-gradient(135deg, #111 0%, #111 100%);
        --gradient-bg: #000000;
        --shadow-glow: 0 0 40px rgba(0, 0, 0, 0.08);
      }
    
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
    
      body {
        font-family: "Poppins", sans-serif;
        background: var(--bg-brown);
        color: var(--ink);
        line-height: 1.6;
        min-height: 100vh;
        position: relative;
        overflow-x: hidden;
      }
    
      /* vignette like screenshot */
      body::before {
        content: "";
        position: fixed;
        inset: 0;
        background: radial-gradient(
          circle at 50% 20%,
          rgba(255, 255, 255, 0.12),
          rgba(0, 0, 0, 0.28) 70%
        );
        pointer-events: none;
        z-index: 0;
      }
    
      /* Header */
      .header {
        padding: 14px 16px;
        background: transparent;
        border-bottom: none;
        position: relative;
        z-index: 10;
      }
    
      .header-content {
        max-width: 560px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
    
      .logo {
        font-size: 1rem;
        font-weight: 800;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.85);
        text-decoration: none;
      }
    
      .back-btn {
        color: rgba(255, 255, 255, 0.75);
        text-decoration: none;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: opacity 0.2s ease;
      }
    
      .back-btn:hover {
        opacity: 0.9;
      }
    
      /* Main Container (looks like paper on brown bg) */
      .checkout-container {
        max-width: 560px;
        margin: 0 auto;
        padding: 18px 14px 50px;
        position: relative;
        z-index: 1;
      }
    
      .checkout-header {
        text-align: center;
        margin: 10px 0 18px;
      }
    
      .checkout-title {
        font-size: 1.1rem;
        font-weight: 800;
        letter-spacing: 0.28em;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.88);
        -webkit-text-fill-color: unset;
        background: none;
        margin-bottom: 6px;
      }
    
      .checkout-subtitle {
        font-size: 0.92rem;
        color: rgba(255, 255, 255, 0.72);
      }
    
      /* Order Summary / Form should feel like 1 big white card */
      .order-summary,
      .checkout-form {
        background: var(--paper);
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: var(--radius);
        padding: 22px;
        margin-bottom: 18px;
        backdrop-filter: none;
        box-shadow: var(--shadow);
      }
    
      /* add a black rounded bar inside each card like screenshot header */
      .summary-title,
      .form-title {
        display: block;
        width: 100%;
        background: var(--blackbar);
        color: #fff;
        text-align: center;
        font-weight: 800;
        letter-spacing: 0.22em;
        text-transform: uppercase;
        padding: 14px 16px;
        border-radius: 999px;
        margin: 0 0 16px;
        font-size: 0.92rem;
      }
    
      /* rows */
      .summary-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        font-size: 0.92rem;
        color: rgba(0, 0, 0, 0.72);
        border-bottom: 1px dashed rgba(0, 0, 0, 0.12);
      }
    
      .summary-item:last-child {
        border-bottom: none;
      }
    
      .summary-total {
        display: flex;
        justify-content: space-between;
        padding: 16px 0 0;
        margin-top: 8px;
        border-top: 1px solid rgba(0, 0, 0, 0.12);
        font-size: 1.05rem;
        font-weight: 800;
        color: var(--ink);
      }
    
      .summary-total .amount {
        color: var(--ink);
        -webkit-text-fill-color: unset;
        background: none;
      }
    
      .price-badge {
        background: #0c0c0c;
        color: #fff;
        padding: 2px 10px;
        border-radius: 999px;
        font-size: 0.7rem;
        font-weight: 800;
        margin-left: 8px;
        letter-spacing: 0.08em;
      }
    
      /* Form fields like screenshot (white + light gray border) */
      .form-group {
        margin-bottom: 18px;
      }
    
      .form-label {
        display: block;
        font-size: 0.92rem;
        font-weight: 800;
        margin-bottom: 8px;
        color: var(--ink);
        text-transform: uppercase;
        letter-spacing: 0.02em;
      }
    
      .form-input,
      .form-select,
      .form-textarea {
        width: 100%;
        padding: 16px 16px;
        background: #fff;
        border: 1px solid #d9d9d9;
        border-radius: 16px;
        color: var(--ink);
        font-size: 1rem;
        font-family: inherit;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }
    
      .form-input:focus,
      .form-select:focus,
      .form-textarea:focus {
        outline: none;
        border-color: rgba(0, 0, 0, 0.35);
        box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.08);
      }
    
      .form-input::placeholder,
      .form-textarea::placeholder {
        color: rgba(0, 0, 0, 0.35);
        font-weight: 600;
      }
    
      .form-select {
        appearance: none;
        cursor: pointer;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%230c0c0c' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 16px center;
      }
    
      .form-textarea {
        resize: vertical;
        min-height: 90px;
      }
    
      /* Submit button: solid black pill */
      .submit-btn {
        width: 100%;
        padding: 18px 18px;
        background: #0c0c0c;
        border: none;
        border-radius: 999px;
        color: #fff;
        font-size: 1.05rem;
        font-weight: 900;
        letter-spacing: 0.08em;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.15s ease;
        margin-top: 10px;
        position: relative;
        overflow: hidden;
        text-transform: uppercase;
        box-shadow: 0 14px 35px rgba(0, 0, 0, 0.25);
      }
    
      /* remove shimmer effect (RoyalSign is clean) */
      .submit-btn::before {
        content: none;
      }
    
      .submit-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 18px 45px rgba(0, 0, 0, 0.35);
      }
    
      .submit-btn:active {
        transform: scale(0.985);
      }
    
      .submit-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
    
      /* Trust Badges: white text on brown bg */
      .trust-badges {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 20px;
        flex-wrap: wrap;
      }
    
      .trust-badge {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.8);
      }
    
      /* Features list: white card subtle */
      .features-list {
        margin-top: 18px;
        padding: 16px;
        background: #fafafa;
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 16px;
      }
    
      .features-list-item {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.9rem;
        color: rgba(0, 0, 0, 0.70);
        padding: 7px 0;
      }
    
      .features-list-item span:first-child {
        color: var(--green);
        font-weight: 900;
      }
    
      /* live preview box (if you enable it later) */
      .live-preview-box {
        background: var(--paper);
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: var(--radius);
        padding: 18px;
        text-align: center;
        margin-bottom: 18px;
        box-shadow: var(--shadow);
      }
    
      .live-preview-label {
        font-size: 0.8rem;
        color: rgba(0, 0, 0, 0.45);
        margin-bottom: 6px;
        font-weight: 700;
        letter-spacing: 0.06em;
        text-transform: uppercase;
      }
    
      .live-preview-signature {
        font-family: "Great Vibes", cursive;
        font-size: 2.6rem;
        color: #0c0c0c;
        min-height: 60px;
        background: none;
        -webkit-text-fill-color: unset;
      }
    
      @media (min-width: 768px) {
        .checkout-container {
          padding: 20px 20px 60px;
        }
    
        .checkout-title {
          font-size: 1.2rem;
        }
      }
    </style>
    
  </head>

  <body>
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <a href="index.html" class="logo">Signature Studio</a>
        <a href="index.html" class="back-btn">‚Üê Back to Home</a>
      </div>
    </header>

    <!-- Checkout Content -->
    <div class="checkout-container">
      <div class="checkout-header">
        <h1 class="checkout-title">üé® Complete Your Order</h1>
        <p class="checkout-subtitle">
          You're one step away from your dream signature!
        </p>
      </div>

      <!-- Order Summary -->
      <div class="order-summary">
        <div class="summary-title">üì¶ Order Summary</div>
        <div class="summary-item" id="packageItem">
          <span>Custom Designer Signature Package</span>
          <span id="packagePrice">‚Çπ4,999</span>
        </div>
        <div class="summary-item" id="discountItem">
          <span>Discount <span class="price-badge">90% OFF</span></span>
          <span style="color: var(--green)" id="discountAmount">-‚Çπ4,510</span>
        </div>
        <div class="summary-total">
          <span>Total</span>
          <span class="amount" id="totalAmount">‚Çπ999</span>
        </div>
      </div>

      <!-- Live Preview -->
      <!-- <div class="live-preview-box">
        <div class="live-preview-label">‚ú® Live Signature Preview</div>
        <div class="live-preview-signature" id="livePreview">Your Name</div>
      </div> -->

      <!-- Checkout Form -->
      <div class="checkout-form">
        <div class="form-title">üìù Your Details</div>

        <form id="checkoutForm" onsubmit="handleSubmit(event)">
          <div class="form-group">
            <label class="form-label" for="name">Your Full Name *</label>
            <input
              type="text"
              id="name"
              class="form-input"
              placeholder="Enter your full name"
              required
              oninput="updatePreview(this.value)"
            />
          </div>

          <div class="form-group">
            <label class="form-label" for="email">Email Address *</label>
            <input
              type="email"
              id="email"
              class="form-input"
              placeholder="your@email.com"
              required
            />
          </div>

          <div class="form-group">
            <label class="form-label" for="phone">WhatsApp / Phone *</label>
            <input
              type="tel"
              id="phone"
              class="form-input"
              placeholder="+91 98765 43210"
              required
            />
          </div>

      

          <div class="form-group">
            <label class="form-label" for="style">Preferred Style</label>
            <select id="style" class="form-select">
              <option value="professional">Professional Executive</option>
              <option value="elegant">Elegant Cursive</option>
              <option value="modern">Modern Minimal</option>
              <option value="creative">Creative Artistic</option>
              <option value="bold">Bold Statement</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label" for="notes"
              >Additional Notes (Optional)</label
            >
            <textarea
              id="notes"
              class="form-textarea"
              placeholder="Any special preferences or requirements in your signtaure design "
            ></textarea>
          </div>

          <button type="submit" class="submit-btn" id="submitBtn">
            üé® Submit Order - ‚Çπ999
          </button>
        </form>

        <!-- Features -->
        <div class="features-list">
          <div class="features-list-item">
            <span>‚úì</span>
            <span>3 unique signature designs</span>
          </div>
          <div class="features-list-item">
            <span>‚úì</span>
            <span>Step-by-step writing tutorial</span>
          </div>
          <div class="features-list-item">
            <span>‚úì</span>
            <span>Printable practice sheets</span>
          </div>
          <div class="features-list-item">
            <span>‚úì</span>
            <span>Delivery in 24-48 hours</span>
          </div>
        </div>
      </div>

      <!-- Trust Badges -->
      <div class="trust-badges">
        <div class="trust-badge">
          <span>üîí</span>
          <span>Secure Checkout</span>
        </div>
        <div class="trust-badge">
          <span>üíØ</span>
          <span>Satisfaction Guaranteed</span>
        </div>
        <div class="trust-badge">
          <span>‚ö°</span>
          <span>Fast Delivery</span>
        </div>
      </div>
    </div>

    <!-- Cashfree JS SDK -->
    <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>

  <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>

<script>
  // ===== Utils =====
  function getAmount() {
    const packageType = document.getElementById("packageType")?.value || "regular";
    return packageType === "legacy" ? 999 : 999;
  }

  function updateAmount() {
    const packageType = document.getElementById("packageType")?.value || "regular";
    const amount = getAmount();
    const totalAmountEl = document.getElementById("totalAmount");
    const submitBtn = document.getElementById("submitBtn");
    const packagePriceEl = document.getElementById("packagePrice");
    const discountAmountEl = document.getElementById("discountAmount");
    const packageItemEl = document.getElementById("packageItem");
    const discountItemEl = document.getElementById("discountItem");
    
    if (totalAmountEl) {
      totalAmountEl.textContent = `‚Çπ${amount}`;
    }
    
    if (submitBtn) {
      submitBtn.innerHTML = `üé® Submit Order - ‚Çπ${amount}`;
    }

    // Update order summary based on package type
    if (packageType === "legacy") {
      if (packagePriceEl) {
        packagePriceEl.textContent = "‚Çπ9,999";
      }
      if (discountAmountEl) {
        discountAmountEl.textContent = "-‚Çπ9,000";
      }
      if (packageItemEl) {
        const span = packageItemEl.querySelector("span:first-child");
        if (span) span.textContent = "Create My Legacy Package";
      }
    } else {
      if (packagePriceEl) {
        packagePriceEl.textContent = "‚Çπ4,999";
      }
      if (discountAmountEl) {
        discountAmountEl.textContent = "-‚Çπ4,510";
      }
      if (packageItemEl) {
        const span = packageItemEl.querySelector("span:first-child");
        if (span) span.textContent = "Custom Designer Signature Package";
      }
    }
  }

  // Initialize on page load
  document.addEventListener("DOMContentLoaded", function() {
    updateAmount();
  });

  function updatePreview(value) {
    const preview = document.getElementById("livePreview");
    if (preview) {
      preview.textContent = value || "Your Name";
    }
  }

  function setBtnLoading(isLoading, text) {
    const submitBtn = document.getElementById("submitBtn");
    if (!submitBtn) return;
    submitBtn.disabled = isLoading;
    const amount = getAmount();
    submitBtn.innerHTML = isLoading ? (text || "‚è≥ Processing...") : `üé® Submit Order - ‚Çπ${amount}`;
  }

  function showError(msg) {
    alert(msg || "Something went wrong. Please try again.");
    setBtnLoading(false);
  }

  function safeJsonParse(text) {
    try { return JSON.parse(text); } catch { return null; }
  }

  // ===== Cashfree init (IMPORTANT) =====
  function getCashfreeInstance() {
    // If your backend creates sandbox sessions, change mode to "sandbox"
    if (typeof window.Cashfree !== "function") return null;
    return window.Cashfree({ mode: "production" });
  }

  // Extract payment_session_id from any common backend response shape
  function extractPaymentSessionId(payload) {
    if (!payload) return null;

    // Most common shapes:
    // 1) { payment_session_id: "..." }
    // 2) { data: { payment_session_id: "..." } }
    // 3) { data: { data: { payment_session_id: "..." } } }  (some wrappers)
    // 4) { paymentSessionId: "..." } (custom)
    return (
      payload.payment_session_id ||
      payload.paymentSessionId ||
      payload?.data?.payment_session_id ||
      payload?.data?.paymentSessionId ||
      payload?.data?.data?.payment_session_id ||
      payload?.data?.data?.paymentSessionId ||
      null
    );
  }

  // ===== Main submit =====
  async function handleSubmit(e) {
    e.preventDefault();
    setBtnLoading(true, "‚è≥ Processing...");

    const packageType = document.getElementById("packageType")?.value || "regular";
    const amount = packageType === "legacy" ? 999 : 999;

    const formData = {
      name: document.getElementById("name")?.value?.trim() || "",
      email: document.getElementById("email")?.value?.trim() || "",
      phone: document.getElementById("phone")?.value?.trim() || "",
      style: document.getElementById("style")?.value || "professional",
      notes: document.getElementById("notes")?.value?.trim() || "",
      packageType: packageType,
      amount: 2,
    };

    if (!formData.name || !formData.email || !formData.phone) {
      showError("Please fill Name, Email, and Phone.");
      return;
    }

    // 1) Create abandoned cart (non-blocking)
    try {
      const abdRes = await fetch(
        "https://signature-backend-x93b.onrender.com/api/lander41/create-order-abd",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            amount: formData.amount,
            fullName: formData.name,
            email: formData.email,
            phoneNumber: formData.phone,
            profession: formData.style,
            remarks: formData.notes,
            additionalProducts: [],
          }),
        }
      );
      const abdText = await abdRes.text();
      const abdData = safeJsonParse(abdText);
      const abdId = abdData?.data?._id;
      if (abdId) localStorage.setItem("abandonedCartID", abdId);
    } catch (err) {
      console.warn("Abandoned cart creation failed:", err);
    }

    // 2) Create payment session
    let paymentSessionId = null;
    let createSessionPayload = null;

    try {
      const res = await fetch(
        "https://signature-backend-x93b.onrender.com/api/payment/create-session",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            amount: formData.amount,
            fullName: formData.name,
            email: formData.email,
            phoneNumber: formData.phone,
            profession: formData.style,
            remarks: formData.notes,
            orderType: formData.packageType === "legacy" ? "legacy" : "normal",
            additionalProducts: [],
            quantity: 1,
            url: window.location.origin + "/royal/cart.html",
          }),
        }
      );

      const raw = await res.text();
      createSessionPayload = safeJsonParse(raw);

      // üî• IMPORTANT: log exact backend response
      console.log("create-session status:", res.status);
      console.log("create-session payload:", createSessionPayload || raw);

      // If backend returned non-JSON
      if (!createSessionPayload) {
        throw new Error("Backend returned non-JSON: " + raw.slice(0, 200));
      }

      // If backend returned an error shape
      if (createSessionPayload.success === false) {
        throw new Error(createSessionPayload.message || createSessionPayload.error || "Session creation failed");
      }

      paymentSessionId = extractPaymentSessionId(createSessionPayload);

      if (!paymentSessionId) {
        // show top-level keys to debug quickly
        console.error("No payment_session_id found. Keys:", Object.keys(createSessionPayload || {}));
        throw new Error("No payment_session_id returned");
      }
    } catch (err) {
      console.error("Create session failed:", err);
      showError(
        "Failed to initiate payment. Backend did not return payment_session_id.\n\nCheck Console -> 'create-session payload'."
      );
      return;
    }

    // 3) Open Cashfree popup
    const cashfree = getCashfreeInstance();
    if (!cashfree) {
      showError("Cashfree SDK failed to load. Please refresh and try again.");
      return;
    }

    try {
      const result = await cashfree.checkout({
        paymentSessionId: paymentSessionId,
        redirectTarget: "_modal", // ‚úÖ popup/modal
      });

      if (result?.error) {
        console.error("Cashfree error:", result.error);
        showError("Payment failed or cancelled.");
        return;
      }

      if (!result?.paymentDetails) {
        showError("Payment not completed.");
        return;
      }

      // 4) Create order after payment
      setBtnLoading(true, "‚úÖ Payment received, saving order...");

      try {
        const orderRes = await fetch(
          "https://signature-backend-x93b.onrender.com/api/lander41/create-order",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              orderId: `order - ${Date.now().toString(36)}`,
              amount: formData.amount,
              fullName: formData.name,
              email: formData.email,
              phoneNumber: formData.phone,
              style: formData.style,
              remarks: formData.notes,
              packageType: formData.packageType,
              additionalProducts: [],
            }),
          }
        );

        const orderRaw = await orderRes.text();
        const orderData = safeJsonParse(orderRaw);

        console.log("create-order status:", orderRes.status);
        console.log("create-order payload:", orderData || orderRaw);

        if (!orderData?.success) {
          throw new Error(orderData?.message || "Order creation failed");
        }

         window.location.href = window.location.origin + "/royal/thankyou.html?name=" + encodeURIComponent(formData.name) + "&email=" + encodeURIComponent(formData.email) + "&style=" + encodeURIComponent(formData.style);
      } catch (err) {
        console.error("Order creation failed:", err);
        showError("Payment success but order creation failed. Please contact support.");
      }
    } catch (err) {
      console.error("Checkout exception:", err);
      showError("Unable to open payment popup. Check domain whitelist + mode (sandbox/production).");
    }
  }
</script>

  </body>
</html>
