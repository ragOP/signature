<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Checkout - Get your custom designer signature from Signature Studio" />
  <title>Checkout - Signature Studio </title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Great+Vibes&display=swap" rel="stylesheet" />
<!-- Meta Pixel Code -->
<script>
!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '1033178425462645');
fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=1033178425462645&ev=PageView&noscript=1"
/></noscript>
<!-- End Meta Pixel Code -->
  <style>
    /* ===== Signature Studio (Warm Cream + Gold) THEME ADAPTED ===== */
    :root{
      --color-cream: #fffbf5;
      --color-warm-light: #fdf6ed;
      --color-warm-beige: #f5ebe0;

      --color-accent-gold: #c9a227;
      --color-accent-bronze: #a67c52;

      --color-text: #2d2a26;
      --color-text-muted: #5c5651;

      --color-success: #2e7d32;

      --gradient-gold: linear-gradient(135deg, #c9a227 0%, #dab43a 50%, #c9a227 100%);
      --bg-page: linear-gradient(145deg, #fffbf5 0%, #fef3e2 50%, #fde8c8 100%);
      --radius: 16px;

      --shadow-soft: 0 14px 45px rgba(45, 42, 38, 0.08);
      --shadow-gold: 0 10px 40px rgba(201, 162, 39, 0.25);

      --font-body: "Poppins", -apple-system, system-ui, sans-serif;
      --font-script: "Great Vibes", cursive;
    }

    *{margin:0;padding:0;box-sizing:border-box;}
    html{scroll-behavior:smooth;}

    body{
      font-family: var(--font-body);
      background: var(--bg-page);
      background-attachment: fixed;
      color: var(--color-text);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* ===== Header ===== */
    .header{
      padding: 16px;
      background: rgba(255, 251, 245, 0.92);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(201, 162, 39, 0.14);
      position: sticky;
      top: 0;
      z-index: 20;
    }
    .header-content{
      max-width: 600px;
      margin: 0 auto;
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 12px;
    }
    .logo{
      font-size: 1.35rem;
      font-weight: 800;
      background: var(--gradient-gold);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-decoration:none;
      letter-spacing: 0.2px;
      white-space: nowrap;
    }
    .back-btn{
      color: var(--color-text-muted);
      text-decoration:none;
      font-size: 0.9rem;
      display:flex;
      align-items:center;
      gap: 6px;
      transition: color .25s ease;
      white-space: nowrap;
    }
    .back-btn:hover{ color: var(--color-accent-gold); }

    /* ===== Main ===== */
    .checkout-container{
      max-width: 520px;
      margin: 0 auto;
      padding: 30px 16px 60px;
    }

    .checkout-header{
      text-align:center;
      margin-bottom: 26px;
    }
    .checkout-title{
      font-size: 1.9rem;
      font-weight: 800;
      margin-bottom: 8px;
      color: var(--color-text);
    }
    .checkout-subtitle{
      font-size: 0.95rem;
      color: var(--color-text-muted);
    }

    /* ===== Cards ===== */
    .order-summary,
    .checkout-form{
      background: rgba(255, 251, 245, 0.92);
      border: 1px solid rgba(201, 162, 39, 0.18);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
    }

    /* ===== Order Summary ===== */
    .order-summary{
      padding: 20px;
      margin-bottom: 20px;
    }
    .summary-title{
      font-size: 1rem;
      font-weight: 800;
      margin-bottom: 14px;
      display:flex;
      align-items:center;
      gap: 8px;
      color: var(--color-text);
    }
    .summary-item{
      display:flex;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 0;
      font-size: 0.92rem;
      color: var(--color-text-muted);
      border-bottom: 1px solid rgba(201, 162, 39, 0.12);
    }
    .summary-item:last-of-type{
      border-bottom:none;
    }
    .summary-item span:last-child{
      font-weight: 700;
      color: var(--color-text);
      white-space: nowrap;
    }

    .price-badge{
      background: var(--gradient-gold);
      color: #fff;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.65rem;
      font-weight: 900;
      margin-left: 8px;
      box-shadow: 0 6px 18px rgba(201,162,39,.18);
      display: inline-flex;
      align-items: center;
      transform: translateY(-1px);
    }

    .summary-total{
      display:flex;
      justify-content: space-between;
      align-items: baseline;
      padding: 16px 0 0;
      margin-top: 10px;
      border-top: 2px solid rgba(201, 162, 39, 0.18);
      font-size: 1.15rem;
      font-weight: 900;
      color: var(--color-text);
    }
    .summary-total .amount{
      background: var(--gradient-gold);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      white-space: nowrap;
    }

    /* ===== Live Preview ===== */
    .live-preview-box{
      background: linear-gradient(145deg, #faf6f0 0%, #f5ebe0 100%);
      border: 2px dashed rgba(201, 162, 39, 0.28);
      border-radius: 12px;
      padding: 20px;
      text-align:center;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(45,42,38,.06);
    }
    .live-preview-label{
      font-size: 0.75rem;
      color: var(--color-text-muted);
      margin-bottom: 8px;
      letter-spacing: 0.10em;
      text-transform: uppercase;
    }
    .live-preview-signature{
      font-family: var(--font-script);
      font-size: clamp(2.2rem, 7vw, 3.2rem);
      color: var(--color-text);
      opacity: 0.9;
      min-height: 60px;
      line-height: 1.1;
      padding: 4px 0;
    }

    /* ===== Form ===== */
    .checkout-form{
      padding: 24px;
    }
    .form-title{
      font-size: 1rem;
      font-weight: 800;
      margin-bottom: 18px;
      color: var(--color-text);
    }
    .form-group{
      margin-bottom: 16px;
    }
    .form-label{
      display: block;
      font-size: 0.85rem;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--color-text);
    }

    .form-input,
    .form-select,
    .form-textarea{
      width: 100%;
      padding: 14px 16px;
      background: rgba(255, 255, 255, 0.75);
      border: 2px solid rgba(201, 162, 39, 0.20);
      border-radius: 12px;
      color: var(--color-text);
      font-size: 1rem;
      font-family: inherit;
      transition: border-color 0.25s ease, box-shadow 0.25s ease, transform 0.25s ease;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus{
      outline: none;
      border-color: var(--color-accent-gold);
      box-shadow: 0 0 0 4px rgba(201, 162, 39, 0.12);
      transform: translateY(-1px);
    }

    .form-input::placeholder,
    .form-textarea::placeholder{
      color: rgba(92, 86, 81, 0.85);
    }

    .form-select{
      appearance: none;
      cursor: pointer;
      padding-right: 44px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23c9a227' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 16px center;
    }

    .form-textarea{
      resize: vertical;
      min-height: 90px;
    }

    /* ===== Submit Button ===== */
    .submit-btn{
      width: 100%;
      padding: 18px;
      background: var(--gradient-gold);
      border: none;
      border-radius: 999px;
      color: #fff;
      font-size: 1.1rem;
      font-weight: 900;
      cursor: pointer;
      transition: transform 0.25s ease, box-shadow 0.25s ease, opacity 0.25s ease;
      margin-top: 8px;
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-gold);
      letter-spacing: 0.2px;
    }

    .submit-btn::before{
      content:"";
      position:absolute;
      top:0;
      left:-100%;
      width:100%;
      height:100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.32), transparent);
      animation: shimmer 2.5s infinite;
    }

    @keyframes shimmer{
      0%{left:-100%;}
      100%{left:100%;}
    }

    .submit-btn:hover{
      transform: translateY(-2px);
      box-shadow: 0 16px 55px rgba(201, 162, 39, 0.35);
    }

    .submit-btn:active{
      transform: scale(0.985);
    }

    .submit-btn:disabled{
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* ===== Features List ===== */
    .features-list{
      margin-top: 18px;
      padding: 16px;
      background: rgba(46, 125, 50, 0.08);
      border: 1px solid rgba(46, 125, 50, 0.18);
      border-radius: 12px;
    }
    .features-list-item{
      display:flex;
      align-items:center;
      gap: 10px;
      font-size: 0.9rem;
      color: var(--color-text-muted);
      padding: 6px 0;
    }
    .features-list-item span:first-child{
      color: var(--color-success);
      font-weight: 900;
    }

    /* ===== Trust Badges ===== */
    .trust-badges{
      display:flex;
      justify-content:center;
      gap: 20px;
      margin-top: 24px;
      flex-wrap: wrap;
    }
    .trust-badge{
      display:flex;
      align-items:center;
      gap: 6px;
      font-size: 0.82rem;
      color: var(--color-text-muted);
      background: rgba(255, 251, 245, 0.75);
      border: 1px solid rgba(201, 162, 39, 0.14);
      border-radius: 999px;
      padding: 8px 12px;
      box-shadow: 0 10px 28px rgba(45,42,38,.06);
    }
    .trust-badge span:first-child{
      font-size: 1rem;
    }

    @media (min-width: 768px){
      .checkout-container{ padding: 50px 20px 70px; }
      .checkout-title{ font-size: 2.2rem; }
    }
  </style>
</head>

<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <a href="https://www.thesignaturestudio.in/light.html" class="logo">Signature Studio </a>
      <a href="https://www.thesignaturestudio.in/light.html" class="back-btn">‚Üê Back to Home</a>
    </div>
  </header>

  <!-- Checkout Content -->
  <div class="checkout-container">
    <div class="checkout-header">
      <h1 class="checkout-title">üé® Complete Your Order</h1>
      <p class="checkout-subtitle">You're one step away from your dream signature!</p>
    </div>

    <!-- Order Summary -->
    <div class="order-summary">
      <div class="summary-title">üì¶ Order Summary</div>
      <div class="summary-item">
        <span>Custom Designer Signature Package</span>
        <span>‚Çπ4,999</span>
      </div>
      <div class="summary-item">
        <span>Discount <span class="price-badge">90% OFF</span></span>
        <span style="color: var(--color-success)">-‚Çπ4,510</span>
      </div>
      <div class="summary-total">
        <span>Total</span>
        <span class="amount">‚Çπ489</span>
      </div>
    </div>

    <!-- Live Preview -->
    <!-- <div class="live-preview-box">
      <div class="live-preview-label">‚ú® Live Signature Preview</div>
      <div class="live-preview-signature" id="livePreview">Your Name</div>
    </div> -->

    <!-- Checkout Form -->
    <div class="checkout-form">
      <div class="form-title">üìù Your Details</div>

      <form id="checkoutForm" onsubmit="handleSubmit(event)">
        <div class="form-group">
          <label class="form-label" for="name">Your Full Name *</label>
          <input
            type="text"
            id="name"
            class="form-input"
            placeholder="Enter your full name"
            required
            oninput="updatePreview(this.value)"
          />
        </div>

        <div class="form-group">
          <label class="form-label" for="email">Email Address *</label>
          <input type="email" id="email" class="form-input" placeholder="your@email.com" required />
        </div>

        <div class="form-group">
          <label class="form-label" for="phone">WhatsApp / Phone *</label>
          <input type="tel" id="phone" class="form-input" placeholder="+91 98765 43210" required />
        </div>

        <div class="form-group" style="display: none;">
          <label class="form-label" for="style">Preferred Style</label>
          <select id="style" class="form-select">
            <option value="professional">Professional Executive</option>
            <option value="elegant">Elegant Cursive</option>
            <option value="modern">Modern Minimal</option>
            <option value="creative">Creative Artistic</option>
            <option value="bold">Bold Statement</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label" for="notes">Additional Notes (Optional)</label>
          <textarea
            id="notes"
            class="form-textarea"
            placeholder="Any special preferences or requirements in your signtaure design "
          ></textarea>
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">üé® Submit Order - ‚Çπ489</button>
      </form>

      <!-- Features -->
      <div class="features-list">
        <div class="features-list-item"><span>‚úì</span><span>3 unique signature designs</span></div>
        <div class="features-list-item"><span>‚úì</span><span>Step-by-step writing tutorial</span></div>
        <div class="features-list-item"><span>‚úì</span><span>Printable practice sheets</span></div>
        <div class="features-list-item"><span>‚úì</span><span>Delivery in 24-48 hours</span></div>
      </div>
    </div>

    <!-- Trust Badges -->
    <div class="trust-badges">
      <div class="trust-badge"><span>üîí</span><span>Secure Checkout</span></div>
      <div class="trust-badge"><span>üíØ</span><span>Satisfaction Guaranteed</span></div>
      <div class="trust-badge"><span>‚ö°</span><span>Fast Delivery</span></div>
    </div>
  </div>

  <!-- Cashfree JS SDK (keep single include) -->
  <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>

  <script>
    // ===== Utils =====
    function updatePreview(value) {
      const preview = document.getElementById("livePreview");
      preview.textContent = value || "Your Name";
    }

    function setBtnLoading(isLoading, text) {
      const submitBtn = document.getElementById("submitBtn");
      if (!submitBtn) return;
      submitBtn.disabled = isLoading;
      submitBtn.innerHTML = isLoading ? (text || "‚è≥ Processing...") : "üé® Submit Order - ‚Çπ2";
    }

    function showError(msg) {
      alert(msg || "Something went wrong. Please try again.");
      setBtnLoading(false);
    }

    function safeJsonParse(text) {
      try { return JSON.parse(text); } catch { return null; }
    }

    // ===== Cashfree init (IMPORTANT) =====
    function getCashfreeInstance() {
      // If your backend creates sandbox sessions, change mode to "sandbox"
      if (typeof window.Cashfree !== "function") return null;
      return window.Cashfree({ mode: "production" });
    }

    // Extract payment_session_id from any common backend response shape
    function extractPaymentSessionId(payload) {
      if (!payload) return null;
      return (
        payload.payment_session_id ||
        payload.paymentSessionId ||
        payload?.data?.payment_session_id ||
        payload?.data?.paymentSessionId ||
        payload?.data?.data?.payment_session_id ||
        payload?.data?.data?.paymentSessionId ||
        null
      );
    }

    // ===== Main submit =====
    async function handleSubmit(e) {
      e.preventDefault();
      setBtnLoading(true, "‚è≥ Processing...");

      const formData = {
        name: document.getElementById("name")?.value?.trim() || "",
        email: document.getElementById("email")?.value?.trim() || "",
        phone: document.getElementById("phone")?.value?.trim() || "",
        style: document.getElementById("style")?.value || "professional",
        notes: document.getElementById("notes")?.value?.trim() || "",
        amount: 489, // keep your backend amount
      };

      if (!formData.name || !formData.email || !formData.phone) {
        showError("Please fill Name, Email, and Phone.");
        return;
      }

      // 1) Create abandoned cart (non-blocking)
      try {
        const abdRes = await fetch(
          "https://signature-backend-x93b.onrender.com/api/lander31/create-order-abd",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              amount: formData.amount,
              fullName: formData.name,
              email: formData.email,
              phoneNumber: formData.phone,
              profession: formData.style,
              remarks: formData.notes,
              additionalProducts: [],
            }),
          }
        );
        const abdText = await abdRes.text();
        const abdData = safeJsonParse(abdText);
        const abdId = abdData?.data?._id;
        if (abdId) localStorage.setItem("abandonedCartID", abdId);
      } catch (err) {
        console.warn("Abandoned cart creation failed:", err);
      }

      // 2) Create payment session
      let paymentSessionId = null;
      let createSessionPayload = null;

      try {
        const res = await fetch(
          "https://signature-backend-x93b.onrender.com/api/payment/create-session",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              amount: formData.amount,
              fullName: formData.name,
              email: formData.email,
              phoneNumber: formData.phone,
              profession: formData.style,
              remarks: formData.notes,
              orderType: "normal",
              additionalProducts: [],
              quantity: 1,
              url: window.location.origin + "/cart.html",
            }),
          }
        );

        const raw = await res.text();
        createSessionPayload = safeJsonParse(raw);

        console.log("create-session status:", res.status);
        console.log("create-session payload:", createSessionPayload || raw);

        if (!createSessionPayload) {
          throw new Error("Backend returned non-JSON: " + raw.slice(0, 200));
        }

        if (createSessionPayload.success === false) {
          throw new Error(createSessionPayload.message || createSessionPayload.error || "Session creation failed");
        }

        paymentSessionId = extractPaymentSessionId(createSessionPayload);

        if (!paymentSessionId) {
          console.error("No payment_session_id found. Keys:", Object.keys(createSessionPayload || {}));
          throw new Error("No payment_session_id returned");
        }
      } catch (err) {
        console.error("Create session failed:", err);
        showError(
          "Failed to initiate payment. Backend did not return payment_session_id.\n\nCheck Console -> 'create-session payload'."
        );
        return;
      }

      // 3) Open Cashfree popup
      const cashfree = getCashfreeInstance();
      if (!cashfree) {
        showError("Cashfree SDK failed to load. Please refresh and try again.");
        return;
      }

      try {
        const result = await cashfree.checkout({
          paymentSessionId: paymentSessionId,
          redirectTarget: "_modal",
        });

        if (result?.error) {
          console.error("Cashfree error:", result.error);
          showError("Payment failed or cancelled.");
          return;
        }

        if (!result?.paymentDetails) {
          showError("Payment not completed.");
          return;
        }

        // 4) Create order after payment
        setBtnLoading(true, "‚úÖ Payment received, saving order...");

        try {
          const orderRes = await fetch(
            "https://signature-backend-x93b.onrender.com/api/lander31/create-order",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                orderId: `order - ${Date.now().toString(36)}`,
                amount: formData.amount,
                fullName: formData.name,
                email: formData.email,
                phoneNumber: formData.phone,
                style: formData.style,
                remarks: formData.notes,
                additionalProducts: [],
              }),
            }
          );

          const orderRaw = await orderRes.text();
          const orderData = safeJsonParse(orderRaw);

          console.log("create-order status:", orderRes.status);
          console.log("create-order payload:", orderData || orderRaw);

          if (!orderData?.success) {
            throw new Error(orderData?.message || "Order creation failed");
          }

          window.location.href =
            window.location.origin +
            "/thankyoulight.html?name=" +
            encodeURIComponent(formData.name) +
            "&email=" +
            encodeURIComponent(formData.email) +
            "&style=" +
            encodeURIComponent(formData.style);
        } catch (err) {
          console.error("Order creation failed:", err);
          showError("Payment success but order creation failed. Please contact support.");
        }
      } catch (err) {
        console.error("Checkout exception:", err);
        showError("Unable to open payment popup. Check domain whitelist + mode (sandbox/production).");
      } finally {
        setBtnLoading(false);
      }
    }
  </script>
</body>
</html>
