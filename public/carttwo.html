<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Checkout - Get your custom designer signature from Signature Studio"
    />
    <title>Checkout | Signature Studio</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@500;600;700&family=Great+Vibes&display=swap"
      rel="stylesheet"
    />

    <style>
      *, *::before, *::after {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --color-bg: #0a0a0f;
        --color-bg-secondary: #12121a;
        --color-surface: rgba(255, 255, 255, 0.03);
        --color-surface-hover: rgba(255, 255, 255, 0.06);
        --color-border: rgba(255, 255, 255, 0.08);
        --color-text: #ffffff;
        --color-text-muted: rgba(255, 255, 255, 0.6);
        --color-text-subtle: rgba(255, 255, 255, 0.4);
        --color-accent: #c9a962;
        --color-accent-light: #e8d5a3;
        --color-accent-glow: rgba(201, 169, 98, 0.3);
        --color-success: #4ade80;
        --gradient-premium: linear-gradient(135deg, #c9a962 0%, #e8d5a3 50%, #c9a962 100%);
        --gradient-bg: radial-gradient(ellipse at top, #1a1a2e 0%, #0a0a0f 50%, #0a0a0f 100%);
        --shadow-glow: 0 0 40px rgba(201, 169, 98, 0.15);
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 20px;
        --radius-full: 9999px;
        --font-display: "Playfair Display", Georgia, serif;
        --font-body: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        --font-script: "Great Vibes", cursive;
      }

      html {
        scroll-behavior: smooth;
      }

      body {
        font-family: var(--font-body);
        background: var(--gradient-bg);
        background-attachment: fixed;
        color: var(--color-text);
        line-height: 1.6;
        min-height: 100vh;
        overflow-x: hidden;
      }

      /* Grain overlay */
      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
        opacity: 0.03;
        pointer-events: none;
        z-index: 0;
      }

      /* Header */
      .header {
        padding: 1rem 1.5rem;
        background: rgba(10, 10, 15, 0.9);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-bottom: 1px solid var(--color-border);
        position: relative;
        z-index: 100;
      }

      .header-inner {
        max-width: 600px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo {
        font-family: var(--font-display);
        font-size: 1.4rem;
        font-weight: 600;
        color: var(--color-text);
        text-decoration: none;
        letter-spacing: -0.02em;
      }

      .logo span {
        background: var(--gradient-premium);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .back-btn {
        color: var(--color-text-muted);
        text-decoration: none;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: color 0.3s ease;
      }

      .back-btn:hover {
        color: var(--color-accent);
      }

      /* Main Container */
      .checkout-container {
        max-width: 500px;
        margin: 0 auto;
        padding: 2rem 1rem 3rem;
        position: relative;
        z-index: 1;
      }

      .checkout-header {
        text-align: center;
        margin-bottom: 2rem;
      }

      .checkout-title {
        font-family: var(--font-display);
        font-size: 2rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        background: var(--gradient-premium);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .checkout-subtitle {
        font-size: 0.95rem;
        color: var(--color-text-muted);
      }

      /* Order Summary Card */
      .order-summary {
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        backdrop-filter: blur(10px);
      }

      .summary-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--color-accent);
      }

      .summary-item {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        font-size: 0.9rem;
        color: var(--color-text-muted);
        border-bottom: 1px solid var(--color-border);
      }

      .summary-item:last-of-type {
        border-bottom: none;
      }

      .summary-total {
        display: flex;
        justify-content: space-between;
        padding: 1rem 0 0;
        margin-top: 0.75rem;
        border-top: 2px solid var(--color-border);
        font-size: 1.1rem;
        font-weight: 700;
      }

      .summary-total .amount {
        background: var(--gradient-premium);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .price-badge {
        background: var(--gradient-premium);
        color: #0a0a0f;
        padding: 2px 10px;
        border-radius: var(--radius-full);
        font-size: 0.65rem;
        font-weight: 700;
        margin-left: 8px;
        display: inline-block;
        vertical-align: middle;
      }

      /* Live Preview */
      .live-preview-box {
        background: linear-gradient(
          135deg,
          rgba(201, 169, 98, 0.08) 0%,
          rgba(232, 213, 163, 0.05) 100%
        );
        border: 1px solid rgba(201, 169, 98, 0.25);
        border-radius: var(--radius-md);
        padding: 1.5rem;
        text-align: center;
        margin-bottom: 1.5rem;
      }

      .live-preview-label {
        font-size: 0.75rem;
        color: var(--color-text-subtle);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: 0.5rem;
      }

      .live-preview-signature {
        font-family: var(--font-script);
        font-size: 2.5rem;
        background: var(--gradient-premium);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        min-height: 60px;
        line-height: 1.2;
      }

      /* Form Card */
      .checkout-form {
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        backdrop-filter: blur(10px);
      }

      .form-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 1.25rem;
        color: var(--color-accent);
      }

      .form-group {
        margin-bottom: 1.25rem;
      }

      .form-label {
        display: block;
        font-size: 0.85rem;
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: var(--color-text-muted);
      }

      .form-input,
      .form-select,
      .form-textarea {
        width: 100%;
        padding: 0.875rem 1rem;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        color: var(--color-text);
        font-size: 1rem;
        font-family: var(--font-body);
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
      }

      .form-input:focus,
      .form-select:focus,
      .form-textarea:focus {
        outline: none;
        border-color: var(--color-accent);
        box-shadow: 0 0 0 3px var(--color-accent-glow);
      }

      .form-input::placeholder,
      .form-textarea::placeholder {
        color: var(--color-text-subtle);
      }

      .form-select {
        appearance: none;
        cursor: pointer;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23c9a962' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 1rem center;
      }

      .form-select option {
        background: var(--color-bg);
        color: var(--color-text);
      }

      .form-textarea {
        resize: vertical;
        min-height: 80px;
      }

      /* Submit Button */
      .submit-btn {
        width: 100%;
        padding: 1.125rem 2rem;
        background: var(--gradient-premium);
        border: none;
        border-radius: var(--radius-full);
        color: #0a0a0f;
        font-size: 1rem;
        font-weight: 700;
        font-family: var(--font-body);
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 0.75rem;
        position: relative;
        overflow: hidden;
        box-shadow: var(--shadow-glow);
      }

      .submit-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        animation: shimmer 2.5s infinite;
      }

      @keyframes shimmer {
        0% { left: -100%; }
        100% { left: 100%; }
      }

      .submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 0 60px rgba(201, 169, 98, 0.4);
      }

      .submit-btn:active {
        transform: scale(0.98);
      }

      .submit-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      /* Trust Badges */
      .trust-badges {
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        margin-top: 1.5rem;
        flex-wrap: wrap;
      }

      .trust-badge {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.75rem;
        color: var(--color-text-subtle);
      }

      .trust-badge .icon {
        font-size: 1rem;
        color: var(--color-accent);
      }

      /* Features List */
      .features-list {
        margin-top: 1.5rem;
        padding: 1rem 1.25rem;
        background: rgba(74, 222, 128, 0.06);
        border: 1px solid rgba(74, 222, 128, 0.15);
        border-radius: var(--radius-md);
      }

      .features-list-item {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.85rem;
        color: var(--color-text-muted);
        padding: 0.4rem 0;
      }

      .features-list-item .check {
        color: var(--color-success);
        font-size: 1rem;
      }

      /* Fade-in animation */
      .fade-in {
        opacity: 0;
        transform: translateY(20px);
        animation: fadeInUp 0.6s ease forwards;
      }
      .fade-in:nth-child(2) { animation-delay: 0.1s; }
      .fade-in:nth-child(3) { animation-delay: 0.2s; }
      .fade-in:nth-child(4) { animation-delay: 0.3s; }

      @keyframes fadeInUp {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (min-width: 768px) {
        .checkout-container {
          padding: 3rem 1.5rem;
        }
        .checkout-title {
          font-size: 2.4rem;
        }
      }
    </style>
  </head>

  <body>
    <!-- Header -->
    <header class="header">
      <div class="header-inner">
        <a href="index.html" class="logo">Signature <span>Studio</span></a>
        <a href="index.html" class="back-btn"><span>‚Üê</span> Back to Home</a>
      </div>
    </header>

    <!-- Main Checkout -->
    <main class="checkout-container">
      <div class="checkout-header fade-in">
        <h1 class="checkout-title">Complete Your Order</h1>
        <p class="checkout-subtitle">
          You're one step away from your premium signature
        </p>
      </div>

      <!-- Order Summary -->
      <div class="order-summary fade-in">
        <h2 class="summary-title"><span>‚ú¶</span> Order Summary</h2>
        <div class="summary-item">
          <span>Premium Signature Package</span>
          <span>‚Çπ4,999</span>
        </div>
        <div class="summary-item">
          <span>Early Bird Discount</span>
          <span style="color: var(--color-success)">-‚Çπ4,510</span>
        </div>
        <div class="summary-item">
          <span>Rush Delivery (24-48 hrs)</span>
          <span style="color: var(--color-success)">FREE</span>
        </div>
        <div class="summary-total">
          <span>Total</span>
          <span class="amount">‚Çπ2 <span class="price-badge">90% OFF</span></span>
        </div>
      </div>

      <!-- Live Preview -->
      <div class="live-preview-box fade-in">
        <div class="live-preview-label">Live Preview</div>
        <div class="live-preview-signature" id="signaturePreview">
          Your Name
        </div>
      </div>

      <!-- Checkout Form -->
      <div class="checkout-form fade-in">
        <h3 class="form-title">‚ú¶ Your Details</h3>

        <!-- IMPORTANT: we keep your working Cashfree submit flow -->
        <form id="checkoutForm" onsubmit="handleSubmit(event)">
          <div class="form-group">
            <label class="form-label" for="fullName">Full Name (for Signature) *</label>
            <input
              type="text"
              id="fullName"
              class="form-input"
              placeholder="Enter your full name"
              required
              oninput="updatePreview(this.value)"
            />
          </div>

          <div class="form-group">
            <label class="form-label" for="email">Email Address *</label>
            <input
              type="email"
              id="email"
              class="form-input"
              placeholder="Where should we deliver?"
              required
            />
          </div>

          <div class="form-group">
            <label class="form-label" for="phone">WhatsApp Number *</label>
            <input
              type="tel"
              id="phone"
              class="form-input"
              placeholder="+91 XXXXX XXXXX"
              required
            />
          </div>

          <div class="form-group">
            <label class="form-label" for="style">Preferred Style</label>
            <select id="style" class="form-select">
              <option value="classic">Classic Elegant</option>
              <option value="modern">Modern Minimal</option>
              <option value="bold">Bold & Confident</option>
              <option value="artistic">Artistic Flourish</option>
              <option value="surprise">Surprise Me!</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label" for="notes">Special Instructions (Optional)</label>
            <textarea
              id="notes"
              class="form-textarea"
              placeholder="Any preferences or special requests..."
            ></textarea>
          </div>

          <button type="submit" class="submit-btn" id="submitBtn">
            ‚ú¶ Pay ‚Çπ2 & Get My Signature
          </button>
        </form>
      </div>

      <!-- Trust Badges -->
      <div class="trust-badges fade-in">
        <div class="trust-badge">
          <span class="icon">üîí</span>
          <span>Secure Payment</span>
        </div>
        <div class="trust-badge">
          <span class="icon">‚ö°</span>
          <span>24-48hr Delivery</span>
        </div>
        <div class="trust-badge">
          <span class="icon">‚ú®</span>
          <span>Premium Quality</span>
        </div>
      </div>

      <!-- Features List -->
      <div class="features-list fade-in">
        <div class="features-list-item">
          <span class="check">‚úì</span>
          <span>3 unique designer signature options</span>
        </div>
        <div class="features-list-item">
          <span class="check">‚úì</span>
          <span>High-resolution files for all purposes</span>
        </div>
        <div class="features-list-item">
          <span class="check">‚úì</span>
          <span>Tutorial + practice sheet included</span>
        </div>
        <div class="features-list-item">
          <span class="check">‚úì</span>
          <span>Lifetime commercial use rights</span>
        </div>
      </div>
    </main>

    <!-- Cashfree JS SDK (keep ONLY once) -->
    <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>

    <script>
      // ===== UI Utils =====
      function updatePreview(value) {
        const preview = document.getElementById("signaturePreview");
        preview.textContent = value || "Your Name";
      }

      function setBtnLoading(isLoading, text) {
        const submitBtn = document.getElementById("submitBtn");
        if (!submitBtn) return;
        submitBtn.disabled = isLoading;
        submitBtn.innerHTML = isLoading
          ? (text || "‚è≥ Processing...")
          : "‚ú¶ Pay ‚Çπ2 & Get My Signature";
      }

      function showError(msg) {
        alert(msg || "Something went wrong. Please try again.");
        setBtnLoading(false);
      }

      function safeJsonParse(text) {
        try { return JSON.parse(text); } catch { return null; }
      }

      // ===== Cashfree init =====
      function getCashfreeInstance() {
        // If your backend creates sandbox sessions, change mode to "sandbox"
        if (typeof window.Cashfree !== "function") return null;
        return window.Cashfree({ mode: "production" });
      }

      // Extract payment_session_id from common backend response shapes
      function extractPaymentSessionId(payload) {
        if (!payload) return null;
        return (
          payload.payment_session_id ||
          payload.paymentSessionId ||
          payload?.data?.payment_session_id ||
          payload?.data?.paymentSessionId ||
          payload?.data?.data?.payment_session_id ||
          payload?.data?.data?.paymentSessionId ||
          null
        );
      }

      // ===== Main submit =====
      async function handleSubmit(e) {
        e.preventDefault();
        setBtnLoading(true, "‚è≥ Processing...");

        const formData = {
          name: document.getElementById("fullName")?.value?.trim() || "",
          email: document.getElementById("email")?.value?.trim() || "",
          phone: document.getElementById("phone")?.value?.trim() || "",
          style: document.getElementById("style")?.value || "classic",
          notes: document.getElementById("notes")?.value?.trim() || "",
          amount: 49, // keep your backend amount
        };

        if (!formData.name || !formData.email || !formData.phone) {
          showError("Please fill Name, Email, and Phone.");
          return;
        }

        // 1) Create abandoned cart (non-blocking)
        try {
          const abdRes = await fetch(
            "https://signature-backend-x93b.onrender.com/api/lander30/create-order-abd",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                amount: formData.amount,
                fullName: formData.name,
                email: formData.email,
                phoneNumber: formData.phone,
                profession: formData.style,
                remarks: formData.notes,
                additionalProducts: [],
              }),
            }
          );
          const abdText = await abdRes.text();
          const abdData = safeJsonParse(abdText);
          const abdId = abdData?.data?._id;
          if (abdId) localStorage.setItem("abandonedCartID", abdId);
        } catch (err) {
          console.warn("Abandoned cart creation failed:", err);
        }

        // 2) Create payment session
        let paymentSessionId = null;
        let createSessionPayload = null;

        try {
          const res = await fetch(
            "https://signature-backend-x93b.onrender.com/api/payment/create-session",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                amount: formData.amount,
                fullName: formData.name,
                email: formData.email,
                phoneNumber: formData.phone,
                profession: formData.style,
                remarks: formData.notes,
                orderType: "normal",
                additionalProducts: [],
                quantity: 1,
                url: window.location.origin + "/cart.html",
              }),
            }
          );

          const raw = await res.text();
          createSessionPayload = safeJsonParse(raw);

          console.log("create-session status:", res.status);
          console.log("create-session payload:", createSessionPayload || raw);

          if (!createSessionPayload) {
            throw new Error("Backend returned non-JSON: " + raw.slice(0, 200));
          }

          if (createSessionPayload.success === false) {
            throw new Error(
              createSessionPayload.message ||
              createSessionPayload.error ||
              "Session creation failed"
            );
          }

          paymentSessionId = extractPaymentSessionId(createSessionPayload);

          if (!paymentSessionId) {
            console.error("No payment_session_id found. Keys:", Object.keys(createSessionPayload || {}));
            throw new Error("No payment_session_id returned");
          }
        } catch (err) {
          console.error("Create session failed:", err);
          showError(
            "Failed to initiate payment. Backend did not return payment_session_id.\n\nCheck Console -> 'create-session payload'."
          );
          return;
        }

        // 3) Open Cashfree popup
        const cashfree = getCashfreeInstance();
        if (!cashfree) {
          showError("Cashfree SDK failed to load. Please refresh and try again.");
          return;
        }

        try {
          const result = await cashfree.checkout({
            paymentSessionId: paymentSessionId,
            redirectTarget: "_modal",
          });

          if (result?.error) {
            console.error("Cashfree error:", result.error);
            showError("Payment failed or cancelled.");
            return;
          }

          if (!result?.paymentDetails) {
            showError("Payment not completed.");
            return;
          }

          // 4) Create order after payment
          setBtnLoading(true, "‚úÖ Payment received, saving order...");

          try {
            const orderRes = await fetch(
              "https://signature-backend-x93b.onrender.com/api/lander30/create-order",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  orderId: `order - ${Date.now().toString(36)}`,
                  amount: formData.amount,
                  fullName: formData.name,
                  email: formData.email,
                  phoneNumber: formData.phone,
                  style: formData.style,
                  remarks: formData.notes,
                  additionalProducts: [],
                }),
              }
            );

            const orderRaw = await orderRes.text();
            const orderData = safeJsonParse(orderRaw);

            console.log("create-order status:", orderRes.status);
            console.log("create-order payload:", orderData || orderRaw);

            if (!orderData?.success) {
              throw new Error(orderData?.message || "Order creation failed");
            }

            window.location.href =
              window.location.origin +
              "/thanyou.html?name=" +
              encodeURIComponent(formData.name) +
              "&email=" +
              encodeURIComponent(formData.email) +
              "&style=" +
              encodeURIComponent(formData.style);
          } catch (err) {
            console.error("Order creation failed:", err);
            showError("Payment success but order creation failed. Please contact support.");
          }
        } catch (err) {
          console.error("Checkout exception:", err);
          showError("Unable to open payment popup. Check domain whitelist + mode (sandbox/production).");
        }
      }
    </script>
  </body>
</html>
